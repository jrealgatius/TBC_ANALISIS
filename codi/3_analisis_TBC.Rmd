---
author: "Ramó Puig, Elena Navas i Jordi Real"
website: "https://github.com/USR-DAPCAT/"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default
  
params:
  metode: "dinamica2"  # "dinamica" / "dinamica2" / "estatica" / "PS" 
  subtitul: ""

title: "Diabetes y Tuberculosis en Ciutat Vella (Barcelona). Estudio longitudinal de la asociación de las dos enfermedades en un distrito con alta prevalencia de tuberculosis"
subtitle: "`r params$subtitul`"

---


&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

# Objectivos

## Objetivo principal

- Analizar la relación epidemiológica y los factores asociados entre la DM y la TB en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona).
- Conocer el riesgo de TB entre la población con DM en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona) para identificar subgrupos de alto riesgo y potencialmente susceptibles de cribado de TB.


## Objetivos secundarios 

- 1.  Comparar la evolución de la prevalencia de la DM y de la TB en el periodo 2006 al 2015 en el distrito de Ciutat Vella, un entorno de alta prevalencia de TB.
- 2.	Conocer la prevalencia y la incidencia de TB entre la población con DM con respecto a la población no diabética.
- 3.	Analizar si el grado de control metabólico de la DM influye en la forma de TB (pulmonar o extrapulmonar), la gravedad y la respuesta al tratamiento.
- 4.	Analizar el papel de la inmigración en la relación entre DM y TB.

-----


## Actualizaciones 

>08/06/2020

&check; Reprogramació cohort dinàmica (Controls sense reemplaçament / Casos Reutilitzats) <br/>
&check; Categorització de paisos <br/>
&check; Actualització de resultats <br/>

## Hecho: 

>15/05/2020

&check; Depuració: Reclassificació de controls a diabetics segons històric de fàrmacs antidiabètics i data d'inclusió (Mínima)<br/>
&check; Depuració: Recalcul d'edat només basat en CIP <br/>
&check; Depuració: Reconsiderar esdeveniment TBC només aquells amb informació a BD ASPB <br/>
&check; Depuració: Detectat i eliminats subjectes per edat (Nascuts post inclusió) <br/>

>

&check; Incluir subjectes amb antecedents TBC <br/>
&check; Agrupació de paisos per árees <br/> 
&check; Anàlisis de sensibilitat amb esdeveniments ASPB <br/>
&check; + Models <br/>
&check; Descriptiu d'esdeveniments de TBC <br/>
&check; Descriptiu de dades ASPB <br/>
&check; Reanàlisis complet <br/>

>

&check; Actualitzat event TBC amb data de tractament / data notificació (primera entre amdues)  / o DET_TB segons E-CAP en cas contrari <br/>
&check; Consideració de qualsevol DM (I o II) <br/>
&check; Primera data de TBC en cas de repetició de TBC <br/>
&check; Eliminats morts a 01/01/2007 (dades agencia i dades e_cap)<br/>
&check; Neteja de dades, data de mort previa a diagnostics i Events <br/>
&check; Anàlisis matching matching Cohort estatíca  <br/>
&check; Anàlisis matching matching Cohort dinàmica amb variables depenent del temps <br/>
&check; Programació dinamica <br/>
&check; Anàlisis temps dependent cohort dinàmica <br/>
&check; Anàlisis exploratori dades agència <br/>
&check; Generació de 251 variables <br/>
&check; Actualització de dades de l'Ecap  <br/>
&check; Vinculació de taules E-cap <br/>
&check; Depuració de dades  <br/>
&check; Reprogramació i generació de resultats  <br/>
&check; Lectura de tablas de históricos de E-Cap proporcionadas por Basic
&check; Agregación en fecha de inclusión (1/2007)
&check; vinculación de tablas en una 
&check; Depuración de errores (Eliminación de duplicados, valores negativos .....) 
&check; Cálculo de variables  
&check; Descriptivo inicial exploratorio 
&check; Análisis de associación de DM versus TBC 
&check; Estimación de incidéncias 

## Pendiente: 

- Depurar base de datos (Corregir errores, definir rango de valores válidos etc...) 
- Etiquetar variables y  valors
- Análisis por objetivos
- Subanálisis

## Consideraciones / limitaciones:

- Solo TBC con fecha disponible
- Excluidos repetidos
- Base de datos vacunas solo disponible a partir de 12/2007 (No en basal)
- Reclasificados expuestos diabeticos en fecha de inclusión (1/2007)
- Possible infraregistro de diagnosticos en 2007
- Alto número de valores faltantes en covariables




```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")
library(ggplot2)
library(dplyr)
library(survminer)
library(compareGroups)

# CArrego funcions -------------------
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

conductor_variables<-here::here("variables_tbc.xls")
conductor_agencia<-here::here("conductor_agencia.xls")

if (params$metode=="dinamica2") dir_output<-"dades/output_dinamic2"
if (params$metode=="dinamica") dir_output<-"dades/output_dinamic"
if (params$metode=="estatica") dir_output<-"dades/output"
if (params$metode=="PS") dir_output<-"dades/output_PS"

```


```{r, include=FALSE}

load(here::here(dir_output,"output3.Rdata"))
dt_ecap<-netejar.noms.variables(dt_ecap) %>% as_tibble()
dades<-dt_ecap


```


```{r formateig, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
# Formateig ----------------
# Calcul de variables noves edat etc..

# Recode dates / factorització 
dades<-dades %>% mutate_at(vars(starts_with("P_G_")), ~if_else(is.na(.),"No","Si")) # Vacunes

dades<-dades %>% mutate_at(vars(starts_with("FP.")), ~if_else(is.na(.),"No","Si")) # Farmacs

dades<-dades %>% mutate(PS=if_else(is.na(PS),0,1))

dades<-dades %>% factoritzar.NO.YES("factoritzarSINO",taulavariables=conductor_variables)

# Recode rangs de valors fora de l'interval a missings Reals (missings de valors reals)
dades<-recode_to_missings(dades,taulavariables = conductor_variables,rang="rang_valid")

# Calcul de dies i anys lliure de TBC 
dades<-dades %>% mutate (dies_lliure_tbc=as.numeric(temps_tbc),anys_lliure_tbc=dies_lliure_tbc/365.25)

# Numero de vegada que apareix un CIP
dades<-dades %>% group_by(CIP) %>% arrange(dtindex) %>% mutate(seq=seq(1:n())) %>% ungroup()

# Dades basals (Prevalents vs incidents )
dades<-dades %>% mutate(any2007=ifelse(anyindex<=2007,"Si","No"))

# Etiquetes de valors
dades<-etiquetar_valors(dades, variables_factors= conductor_variables,fulla="etiquetes")

# # Relevel 
# dades2<- dades2 %>% mutate(grup=relevel(grup, "Control"))

# Recode paisos
dades<-etiquetar_valors(dades,conductor_variables,fulla = "nacionalitats",camp_etiqueta = "etiqueta2",missings = TRUE)

# Etiquetació de variables  -----------
dades<-etiquetar(dades,taulavariables = conductor_variables,camp_descripcio = "Descripcio")


# Comprovar events durant seguiment
# dades %>% filter(!is.na(DET_TB) | !is.na(DET2_TB) | event_tbc==1) %>% select(DET_TB,DET2_TB,event_tbc,filtre_TBC)
# dades %>% filter(event_tbc==1) %>% transmute(DET_TB,DET2_TB,event_tbc,filtre_TBC)
# dades %>% filter(!is.na(DET2_TB)) %>% transmute(case.id,CIP,dtindex,DET_TB,lubridate::as_date(DET2_TB),event_tbc,filtre_TBC,grup)
# 
# dades %>% distinct(CIP)



```


```{r formateig_agencia, include=T}
#variable.names(dt_plana_agencia)
dt_agencia<-netejar_espais(dt_agencia)
dt_agencia<-netejar.noms.variables(dt_agencia)

# Repetits
N_CIP<-dt_agencia%>% filter(repe>1)%>% select(CIP)

# Filtrar dades de TBC incloses en subestudi dades ecap)
dt_agencia<-dt_agencia %>% semi_join(dt_ecap, by="CIP") 

#RECODES / CALCULS     
dt_agencia<-dt_agencia %>% mutate(MORT2=if_else(is.na(MORT),0,1))

# Variable indicadora dades TBC provinents agencia
dt_agencia<-dt_agencia %>% mutate(dt_agencia=ifelse(is.na(NUM_REG),0,1))

# Factoritzar
vars_factor<-extreure.variables("factoritzar",conductor_agencia)
dt_agencia<-dt_agencia %>% mutate_at(vars_factor,as.factor)

# Etiquetar 
dt_agencia<-etiquetar(d=dt_agencia,taulavariables=conductor_agencia)
dt_agencia<-etiquetar_valors(dt=dt_agencia,variables_factors=conductor_agencia,fulla="etiquetes",camp_etiqueta="etiqueta2")


# Events segons dades agencia
# Capturar si l'event ve de dades d'agencia o NO 
dt_temp<-select(dt_agencia,CIP,TBC_agencia=dt_agencia) %>% unique()
dades<-dades %>% left_join(dt_temp,by="CIP")

dades<-dades %>% mutate(event_tbc_agencia=ifelse(event_tbc==1 & TBC_agencia==0,0,event_tbc))

# Surv Tbc agencia
dades$surv_tbc_agencia<-with(dades,Surv(temps_tbc, event_tbc_agencia))

# dades %>% filter(event_tbc==1) %>% distinct(CIP)
# dades %>% filter(event_tbc_agencia==1) %>% distinct(CIP)
# temp<-dades %>% filter(event_tbc_agencia==1) %>% select(case.id, CIP,event_tbc_agencia,grup) %>% distinct(case.id)


```

# Método 
- Diseño de Cohortes retrospectivas.  
- Periodo de reclutamiento: 2007 / 2007-2016 con seguimiento hasta 31/12/2018
- Criterios de inclusión: Pacientes de **Ciutat Vella** incluidos en registros clínicos vinculados con el registro del programa de prevención y control de Tuberculosi de Barcelona. 
- Fuentes de datos: 

### Método de seleccion de controles cohorte dinámica:

A case is a person who is recorded as diabetes at index date. A control is a person who has not yet have diabetes at the index date of the case. The index date of the case can also be the onset of a disease (or other exposure), in which case controls are persons who do not yet have the disease (are not yet exposed). See incidenceMatch for situations where a case has a time to event outcome at the index date and controls do not have the outcome at the case index date.

Within a cohort or registry study, a number of controls are matched to each case on demographics, comorbidity, concomitant medication and other pre-treatment person characteristics measured at the index date of the case.

Matching may be useful in non-randomized studies when the aim is to estimate a

* causal parameter: The average effect of treatment in a hypothetical study which randomizes treatment allocation. E.g., the difference or ratio of the absolute risk of developing an outcome within the first 6 months after the index date.

* regression parameter: The conditional effect of treatment (exposure) on an outcome given pre-treatment (pre-exposure) covariates. E.g., a hazard ratio in a Cox regression model, or an odds ratio in a logistic regression model. In particular, when it is difficult or expensive or time-consuming to measure pre-exposure variables or to remove model dependency. See Details and references.


## Análisis 

1. Cálculo de incidéncia de TBC global y por grupos segun casos incidentes de TBC detectados y usando como denominador las personas-tiempo seguidas.  
2. Para analizar el riesgo de TBC associada a la Diabetis y otros factores associados se han usado modelos de regressión de COX con variables dependientes del tiempo. La cohorte dinámica se ha Modelos de COX usados han sido por clusters. The cluster term is used to compute a robust variance for the model. The term + cluster(id) where each value of id is unique is equivalent to specifying the robust=TRUE argument. If the id variable is not unique, it is assumed that it identifies clusters of correlated observations.

## Flowchart

```{r flow_filtres,include=T}



criteris_exclusio_diagrama(dades,taulavariables = conductor_variables,criteris = "exc",ordre="exc_ordre",etiquetes = "Descripcio",sequencial = T,grups = "grup")



```


```{r aplica_filtres,include=T}

dades<-dades %>% criteris_exclusio(conductor_variables,"exc")

# s'ha de tornar a etiquetar després de criteris_exclusió
# Etiquetació de variables  -----------
dades<-etiquetar(dades,taulavariables = conductor_variables,camp_descripcio = "Descripcio")



```


# Resultats

## Exploratori de validació 

```{r exploratori, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

# T BASAL -------------
formu<-formula_compare(x="basales",y="grup",taulavariables = conductor_variables)

descrTable(formu,data=dades,show.p.overall = F,show.n = T,method = 2,Q1=0,Q3=1) %>%
  export2md(caption = "Mediana [Min; Max] Descriptiva de validació per grups")



```


## Característiques basals per grups

- Descriptiu de característiques basals entre grups


```{r resultats1, include=T, warning=FALSE,echo=FALSE, message=F}

formu<-formula_compare(x="basales",y="grup",taulavariables = conductor_variables)
T1_BASAL<-descrTable(formu,data=dades,show.p.overall = T,show.n = T, hide.no = T,hide = "No")

export2md(T1_BASAL,caption = "Descriptiva de caracterítiques basals entre grups (Frequencia, Mitjana (SD))")

# # Validació missing age 
# dades %>% filter(is.na(age)) %>% select(age,dNaixement,dtindex)
# dt_ecap %>% select(age,dNaixement,dtindex)

# Seleccionar CIPs unics  per descriptiva
set.seed(1)
dades_CIP<-dades %>% group_by(CIP) %>% sample_n(1) %>% ungroup()
# descrTable(grup~DG.TBC_cat,data=dades_CIP,show.p.overall = T,show.n = T, hide.no = T)
# descrTable(formu,data=dades_CIP,show.p.overall = T,show.n = T, hide.no = T,hide = "No")


```


## Incidència global de TBC (TBC només confirmats segons dades ASPB)

```{r resultats5, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
# T BASAL -------------

kable(resum_events(dades = dades,evento="event_tbc",temps="anys_lliure_tbc",valorevent = "1"),caption="Resum d'events") %>% kableExtra::kable_styling()

taula_IA_grup<-dades %>% base::split(dades$grup) %>% 
  map(~resum_events(dades = .x,evento="event_tbc",temps="anys_lliure_tbc",valorevent = "1")) %>% 
  map(as_tibble) %>% 
  map_df(bind_rows,.id = "grup") %>% 
  as_tibble()

kable(taula_IA_grup,caption="Resum d'events per exposició a diabetis") %>% kableExtra::kable_styling()
descrTable(surv_tbc~grup,data=dades,show.ratio = T, byrow = T ) %>% export2md(caption = "Incidència i Hazard Ratio de Tuberculosis")
```


## HR Crus i ajustats

```{r resultats7, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

if (params$metode=="dinamica2") cluster="case.id" else cluster=""

HR.COX(x="DM_cru",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR cru") %>% kableExtra::kable_styling()

HR.COX(x="DM_ajust",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR ajustats segons covariables") %>% kableExtra::kable_styling()

HR.COX(x="DM_ajust2",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR ajustats segons covariables") %>% kableExtra::kable_styling()



```

## Incidència TBC per pais

```{r,message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}
kable(resum_events_grup(dades,
                  evento="event_tbc",
                  temps="anys_lliure_tbc",
                  grup="descNacionalitat"),
      caption="Resum Incidència per País") %>% kableExtra::kable_styling()
```


## Supervivencia lliure d'esdeveniment K-M (TBC)

```{r figura1, include=T, fig.asp=1}
survfit(surv_tbc ~ grup, data=dades) %>%
  ggsurvplot(title="TB detection in patient with or without DM",
             p.val=T, xlab="Time (Years)", censor=F, linetype="strata",
             fun="event", cumevents = T,risk.table = F,xscale=365.25,break.x.by = 365.25)
```


## Gràfica estimada del Model de cox

```{r figura_COX, include=T, fig.asp=1, results="asis"}

if (params$metode=="dinamica2") res.cox<-coxph(surv_tbc ~ grup+sexe+age+cluster(case.id), data=dades) 
if (params$metode!="dinamica2") res.cox<-coxph(surv_tbc ~ grup+sexe+age, data=dades) 

res.cox %>% sjPlot::tab_model(show.p = FALSE)

summary(res.cox)

ggadjustedcurves(res.cox, data=dades,method = "average", variable = "grup" , fun="cumhaz",
                 title="Fitted Cox Model to TB detection in patient with or without DM")


ggadjustedcurves(res.cox, data=dades,method = "average", variable = "grup", fun="event",
                 title="Fitted Cox Model to TB detection in patient with or without DM")




```


## Objetivos secundarios

- 3.	Grado de control metabólico de la DM influye en la forma de TB (pulmonar o extrapulmonar), la gravedad y la respuesta al tratamiento.

```{r, include=T}

HR.COX(x="HB_cru",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR segons increment de HbA1c(%)") %>% kableExtra::kable_styling()

HR.COX(x="HB_ajust",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR ajustats segons covariables") %>% kableExtra::kable_styling()

HR.COX(x="HB_ajust2",event = "event_tbc",t="temps_tbc",d=dades,taulavariables = conductor_variables,c=cluster) %>% 
  kable(digits = 3,caption = "HR ajustats segons covariables") %>% kableExtra::kable_styling()



```

## Diabetics per any de seguiment

```{r, include=T}
# Numero de DM prevalents per any
dades %>% mutate(any_DM=year(DG.DM),any_DM=ifelse(any_DM<=2007,"<=2007",as.character(any_DM))) %>% 
  group_by(any_DM) %>% filter(!is.na(any_DM)) %>%   
  summarise('Núm diabetics'=n_distinct(CIP)) %>% 
  kable(digits = 3,caption = "Diabètics a 2007 i incidents per any d'inclusió") %>% kableExtra::kable_styling()
  
```

## Frequencia de casos de TBC's durant el seguiment 

```{r, include=T}
# Dades de TBC
dades %>% filter(!is.na(DET_TB)) %>% 
  select(CIP,dtindex,DET_TB,any_TBC,event_tbc,event_tbc_agencia,EV.TBC_cat,DET2_TB,TBC_agencia,seq,dt_lliure_TBC) %>% 
  summarise(num_reg=n(),Pacients_diferents=n_distinct(CIP)) %>% 
  kable(digits = 3,caption = "Casos de TBC en la base de dades") %>% kableExtra::kable_styling()
            
# dades agencia
dades %>% filter(!is.na(DET_TB)) %>% filter(TBC_agencia==1) %>% 
  select(CIP,dtindex,DET_TB,any_TBC,event_tbc,event_tbc_agencia,EV.TBC_cat,DET2_TB,TBC_agencia,seq,dt_lliure_TBC) %>% 
  summarise(num_reg=n(),Pacients_diferents=n_distinct(CIP)) %>% 
  kable(digits = 3,caption = "Casos de TBC registrats en la base de dades de l'agència SP") %>% kableExtra::kable_styling()

# dades TBC classificats com a esdeveniments 
dades %>% filter(!is.na(DET_TB)) %>% filter(event_tbc==1) %>% 
  select(CIP,dtindex,DET_TB,any_TBC,event_tbc,event_tbc_agencia,EV.TBC_cat,DET2_TB,TBC_agencia,seq,dt_lliure_TBC) %>% 
  summarise(num_reg=n(),Pacients_diferents=n_distinct(CIP)) %>% 
  kable(digits = 3,caption = "Casos de TBC durants seguiment") %>% kableExtra::kable_styling()

# Events agrupats per any
dades %>% filter(!is.na(DET_TB)) %>% filter(event_tbc==1) %>% 
  select(CIP,dtindex,DET_TB,any_TBC,event_tbc,event_tbc_agencia,EV.TBC_cat,DET2_TB,TBC_agencia,seq,dt_lliure_TBC,any2007,any_TBC) %>% group_by(any_TBC) %>% 
  summarise(N=n()) %>% 
  kable(digits = 3,caption = "Casos de TBC per any durant seguiment") %>% kableExtra::kable_styling()



```


# Estudi exploratori dades de ASPB

> Descriptiu general del tots els casos de TBC ja siguin antencedents o events de la base de dades de l'Agència

```{r filtre_agencia,include=T}

# Dubtes de si filtrar per subestudi o no

# Grups de dades general

# 1. Dades amb qualsevol event registrat (Agencia o E-CAP) (N=703) dels que tinc a E-CAP (Events + Antecedents) 
# 2. Dades de pacients de subestudi presentat que compleixen criteris d'inclusió (excloents antecedents de TBC ambdues fonts)
# 3. Dades dels pacients del subestudi presentat sense excloure antecedents, independentment del seguiment

# Filtro dades de l'agencia


dt_agencia <- dt_agencia %>% filter(dt_agencia==1) 

dt_agencia %>% select(CIP,DET_TB,event_tbc) %>% 
  summarise(n(),n_distinct(CIP), 'Events TBC'= sum(event_tbc=="Si")) %>% 
  kable(digits = 3,caption = "Casos de TBC de la base de dades de l'Agència") %>% kableExtra::kable_styling()


``` 
 
## Descriptiu de tots els casos TBC identificats per ASPB

```{r resultats_agencia,include=T}
dt_temp<-dt_agencia

formula<-formula.text("taula",y="",taulavariables = conductor_agencia)
descrTable(formula,data=dt_temp,max.xlev = 100,show.n = T,hide.no="NO",simplify=F,method = 2, Q1=0,Q3=1) %>% 
  export2md(caption = "Descriptiva dades: Frequencia, Mín i Max)")

```


## Descriptiu nomes events TVC del subestudi


```{r, include=T}

dt_temp<-dt_agencia %>% filter(event_tbc=="Si" & PS==1)


formula<-formula.text("taula",y="",taulavariables = conductor_agencia)
descrTable(formula,data=dt_temp,max.xlev = 100,show.n = T,hide.no="NO",simplify=F,method = 2, Q1=0,Q3=1) %>% 
  export2md(caption = "Descriptiva dades: Frequencia, Mín i Max)")



```


&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ </a></p>
<p style="text-align: center;">$Llepali-System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



