---
title: "Diabetes y Tuberculosis en Ciutat Vella (Barcelona). Estudio longitudinal de la asociación de las dos enfermedades en un distrito con alta prevalencia de tuberculosis"
author: "Elena Navas & Jordi Real"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())

# Lectura de funcions -------------
#   SOURCE
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

library("compareGroups")
library("knitr")
library("dplyr")
library("lubridate")
library("DT")


# Paràmetres
conductor_variables<-here::here("variables_tbc.xls")


# Lectura de dades ---------------
dades<-readRDS(here::here("dades","dades.RDS"))
psalut_historic <- readRDS(here::here("dades", "psalut_historic.RDS"))
psalut <- readRDS(here::here("dades", "psalut.RDS"))

dt_historic_farmacs <- readRDS(here::here("dades", "dt_historic_farmacs.RDS"))
dt_farmacs <- readRDS(here::here("dades", "dt_farmacs.RDS"))
dt_tuberculosos <- readRDS(here::here("dades", "dt_tuberculosos.RDS"))


variables<-readxl::read_excel(conductor_variables,col_types = "text")

```

# Objectivos

## Objetivo principal

- Analizar la relación epidemiológica y los factores asociados entre la DM y la TB en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona).
- Conocer el riesgo de TB entre la población con DM en un distrito de elevada prevalencia de TB (Ciutat Vella de Barcelona) para identificar subgrupos de alto riesgo y potencialmente susceptibles de cribado de TB.


## Objetivos secundarios 

- 1. Comparar la evolución de la prevalencia de la DM y de la TB en el periodo 2006 al 2015 en el distrito de Ciutat Vella, un entorno de alta prevalencia de TB.
- 2.	Conocer la prevalencia y la incidencia de TB entre la población con DM con respecto a la población no diabética.
- 3.	Analizar si el grado de control metabólico de la DM influye en la forma de TB (pulmonar o extrapulmonar), la gravedad y la respuesta al tratamiento.
- 4.	Analizar el papel de la inmigración en la relación entre DM y TB.


-----

## Hecho: 

- Lectura de tablas de históricos de E-Cap proporcionadas por Basic
- Agregación en fecha de inclusión (1/2007)
- vinculación de tablas en una
- Depuración de errores (Eliminación de duplicados, valores negativos .....)
- Cálculo de variables
- Descriptivo inicial exploratorio
- Análisis de associación de DM versus TBC
- Estimación de incidéncias


## Pendiente: 

- Depurar base de datos (Corregir errores, definir rango de valores válidos etc...) 
- Etiquetar variables
- Análisis por objetivos
- Reanálisis cohorte dinámica

## Consideraciones / limitaciones:

- No hay datos de fármacos en fecha basal (Solamente a partir de 2009) --> agregación hecha en fecha 2009
- Base de datos vacunas solo disponible a partir de 12/2007 (No en basal)
- Reclasificados expuestos diabeticos en fecha de inclusión (1/2007)
- Possible infraregistro de diagnosticos en 2007
- Alto número de valores faltantes


```{r formateig, message=FALSE, warning=FALSE, include=F, echo=FALSE,size="huge"}

# Formateig ----------------

# Netejar noms de variables 
dades<-netejar.noms.variables(dades)
# Espais en blanc
dades<-netejar_espais(dades)

# Calcul de variables noves edat etc..


dades<-dades %>% mutate(dtindex=ifelse(is.na(dtindex),"20070101",dtindex),
                 age=as.period(interval(start =NAIX , end = ymd(dtindex))) %>% year()) 

# Recode dates / factorització 
dades<-dades %>% mutate_at(vars(starts_with("DG."),starts_with("EV.")), ~if_else(is.na(.),"No","Si")) # Diagnostics
dades<-dades %>% mutate_at(vars("event_tb"), ~if_else(is.na(.) | .==0,"No","Si")) # Events 
dades<-dades %>% mutate_at(vars(starts_with("P_G_")), ~if_else(is.na(.),"No","Si")) # Vacunes

# Recode rangs de valors fora de l'interval a missings Reals (missings de valors reals)
dades<-recode_to_missings(dades,taulavariables = conductor_variables,rang="rang_valid")



# Etiquetació de variables  -----------


dades<-etiquetar(dades,taulavariables = conductor_variables,camp_descripcio = "Descripcio")


```


```{r exclusions, message=FALSE, warning=FALSE, include=F, echo=FALSE,size="huge"}

# EXCLUSIONS





```

## Resum d'historics de problemes de salut

```{r exploratori, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge", error=FALSE}

psalut %>% group_by(cod) %>% summarize(n(), min(dat),max(dat)) %>% datatable( caption="Problemes de salut historics originals")
psalut_historic %>% group_by(cod,agr) %>% summarize(n(), min(dat),max(dat)) %>% datatable(caption="Problemes de Salut dels CIPS d'estudi")



```

## Exploratori d'historics de farmacs

```{r exploratori2, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge", error=FALSE}

dt_historic_farmacs %>% group_by(cod) %>% summarize(n(), mindata=min(data_ini,na.rm=T),maxdata=max(data_ini,na.rm=T)) %>% datatable( caption="Fàrmacs historics originals")

dt_farmacs %>% group_by(cod,agr) %>% summarize(n(), mindata=min(data_ini,na.rm=T),maxdata=max(data_ini,na.rm=T)) %>% datatable(caption="Fàrmacs historics de CIPS de la taula")




```


# Analisis exploratori 

## Descriptiva Basal 

```{r analisis1, message=FALSE, warning=FALSE, include=F, echo=FALSE,size="huge", error=FALSE}

# T BASAL -------------

formula<-formula_compare(x="basales",y="DG.DM",taulavariables = conductor_variables)
T1_BASAL<-descrTable(formula,data=dades,show.p.overall = F,show.n = T,method = 2,Q1=0,Q3=1)
taula1<-export2md(T1_BASAL,caption = "Descriptiva de caracterítiques basals entre grups")

formula<-formula_compare("events",y="DG.DM",taulavariables = conductor_variables)
T1_BASAL<-descrTable(formula,data=dades,show.p.overall = F,show.n = T,method = 2,Q1=0,Q3=1)
taula2<-export2md(T1_BASAL,caption = "Descriptiva de caracterítiques basals entre grups")

# taula3<-kable(calcular_proporcio(dades,factor ="descNacionalitat" ),digits = 3) %>% kableExtra::kable_styling()




```

```{r}

taula1

taula2

# taula3



```



## Incidencia de TBC en funció de DM i caracteristiques basals (Outcomes)

```{r analisis2, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

# T BASAL -------------


kable(resum_events(dades = dades,evento="event_tb",temps="any_TB",valorevent = "Si"),caption="Resum d'events") %>% kableExtra::kable_styling()


taula_IA_grup<-dades %>% base::split(dades$DG.DM) %>% 
  map(~resum_events(dades = .x,evento="event_tb",temps="any_TB",valorevent = "Si")) %>% 
  map(as_tibble) %>% 
  map_df(bind_rows,.id = "grup") %>% 
  as_tibble()

kable(taula_IA_grup,caption="Resum d'events per exposició a diabetis") %>% kableExtra::kable_styling()

dades$Z_Surv  <- Surv(dades$any_TB, dades$event_tb=="Si")
formula<-formula_compare("basales",y="Z_Surv",taulavariables = conductor_variables)
T2_BASAL<-descrTable(formula,data=dades,show.p.overall = T,show.n = T, show.ratio = T)
export2md(T2_BASAL,caption = "HR de TBC segons caracterítiques basals entre grups")



```



```{r analisis3, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge"}

library(survminer)
Z_Surv  <- Surv(dades$any_TB, dades$event_tb=="Si")

survfit(Z_Surv ~ DG.DM+sexe, dades, conf.type = "log-log") %>%
  ggsurvplot(title="TB detection in patient with or without DM",
             p.val=T, xlab="Time (Years)", censor=F, linetype="strata",
             fun="event", cumevents = T, xlim=c(0,13))


# 

```

```{r analisis4, message=FALSE, warning=FALSE, include=T, echo=FALSE,size="huge" }


dades<-dades %>% mutate(event_tb_dic=event_tb=="Si")

extreure_OR("event_tb_dic~DG.DM+age+sexe+visites_MG",dades=dades) %>% kable(digits=3)


descrTable(dt_tuberculosos) %>% export2md(caption = "Descriptivo de casos detectados de TBC")



```


